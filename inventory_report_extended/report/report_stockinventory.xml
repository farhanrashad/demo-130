<odoo>
    <data>
        <template id="report_inventory_inherit_extended" inherit_id="stock.report_inventory">
            <xpath expr="//table/thead/tr" position="inside">
                <th class="text-right"><strong>Variance</strong></th>
            </xpath>
            <xpath expr="//tr[@t-foreach='o.line_ids.filtered(lambda line: line.location_id.id == location.id)']" position="before">
                <t t-set="total_onhand" t-value="0"/>
                <t t-set="total_counted" t-value="0"/>
                <t t-set="total_variance" t-value="0"/>
            </xpath>
            <xpath expr="//tr[@t-foreach='o.line_ids.filtered(lambda line: line.location_id.id == location.id)']" position="inside">
                <t t-set="total_onhand" t-value="total_onhand + line.theoretical_qty"/>
                <t t-set="total_counted" t-value="total_counted + line.product_qty"/>
                <t t-set="total_variance" t-value="total_variance + (line.product_qty - line.theoretical_qty)"/>
                <td class="text-right"><t t-esc="line.product_qty - line.theoretical_qty"/></td>
            </xpath>
            <xpath expr="//tr[@t-foreach='o.line_ids.filtered(lambda line: line.location_id.id == location.id)']" position="after">
                <tr>
                    <td groups="stock.group_stock_multi_locations"><strong>TOTAL</strong></td>
                    <td groups="stock.group_production_lot"></td>
                    <td></td>
                    <td class="text-right"><strong><t t-esc="total_onhand"/></strong></td>
                    <td class="text-right"><strong><t t-esc="total_counted"/></strong></td>
                    <td class="text-right"><strong><t t-esc="total_variance"/></strong></td>
                </tr>
            </xpath>
        </template>
    </data>
</odoo>
